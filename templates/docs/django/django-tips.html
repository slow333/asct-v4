{% extends 'base/base.html' %}

{% block title %} Django Note {% endblock %}

{% block content %}

{% include 'docs/django/sub_nav.html' %}
<div class="container py-1">
  <div class="mb-1 pb-2">
    <h1 class="doc-title">Django 개발 팁 & 노트</h1>
    <p class="lead text-white">Django 프로젝트 개발 중 발생한 이슈와 해결 방법, 유용한 코드 스니펫을 정리한 문서입니다.</p>
  </div>

    <!-- Section 1: Model & Form -->
  <section id="sec-model-form" class="doc-section">
    <h2 class="doc-header"><i class="bi bi-window-sidebar me-2"></i>Django Model, Form 관련</h2>
    
    <article>
      <h4 class="doc-subheader"><i class="bi bi-hash"></i>EventAdmin list_display에 ManyToMany 필드 표시</h4>
      <p>Admin 목록 화면에서 ManyToMany 필드를 직접 표시할 수 없으므로, 커스텀 메서드를 정의하여 문자열로 변환해 보여줍니다.</p>
      <pre>
@admin.register(Event)
class EventAdmin(admin.ModelAdmin):
list_display = ('name', 'description','event_date', 'venue', 'manager', 'display_attendees')
autocomplete_fields = ('manager','attendees')
list_filter = ('event_date', 'venue')
ordering = ('-event_date',)
list_select_related = ('venue','manager')
search_fields = ('manager','name',)

def display_attendees(self, obj):
    return ", ".join([str(attendee) for attendee in obj.attendees.all()])
display_attendees.short_description = '참석자'
</pre>
    </article>
    <article>
      <h4 class="doc-subheader"><i class="bi bi-hash"></i>Django slug에서 한글 안됨</h4>
      <p>한글 부분을 삭제하고, 영문+id로 구성</p>
      <pre>
UPDATE eshop_product 
SET slug = LOWER(CONCAT('product-', id))
WHERE id IN (
    SELECT id FROM eshop_product 
    WHERE name ~ '[^a-zA-Z0-9\s\-]' -- 한글, 한자, 특수문자 포함 확인
);
</pre>
    </article>

    <article>
      <h4 class="doc-subheader"><i class="bi bi-hash"></i>DB 기존 데이터에 Thumbnail 일괄 생성</h4>
      <div class="note-box">
        <p class="mb-0"><strong>상황:</strong> `events_favorite` 테이블에 데이터는 있지만 썸네일이 생성되지 않은 경우 사용합니다. Favorite 모델의 `save()` 메서드에 썸네일 생성 로직이 포함되어 있으므로, 객체를 불러와 `save()`를 호출하면 됩니다.</p>
      </div>
      <p>터미널에서 <code>python manage.py shell</code>을 실행한 후 아래 코드를 입력하세요.</p>
<pre>
from events.models import Favorite
from django.db.models import Q

def generate_thumbnails():
# 썸네일이 없거나(NULL) 빈 문자열인 항목 조회
missing_thumbnails = Favorite.objects.filter(Q(thumbnail__isnull=True) | Q(thumbnail=''))

total = missing_thumbnails.count()
print(f"썸네일 생성 대상: 총 {total}건")

success_count = 0
for fav in missing_thumbnails:
  # 이미지가 존재하는 경우에만 처리
  if fav.image:
    try:
      print(f"[{success_count + 1}/{total}] 처리 중: {fav.name}")
      # save() 호출 시 모델 내부 로직에 의해 썸네일이 자동 생성됨
      fav.save()
      success_count += 1
    except Exception as e:
      print(f" -> 실패 ({fav.name}): {e}")
  else:
    print(f" -> 스킵 ({fav.name}): 원본 이미지 없음")
print(f"\n작업 완료: {success_count}개의 썸네일이 생성되었습니다.")

# 함수 실행
generate_thumbnails()
</pre>
    </article>

    <article>
      <h4 class="doc-subheader"><i class="bi bi-hash"></i>EventForm에서 attendees에 name과 id를 표시하기</h4>
      <p>Form에서 리스트 목록에 필요한 항목을 추가해서 표시하기 위해 `label_from_instance`를 오버라이딩합니다.</p>
<pre>
class AttendeeChoiceField(forms.ModelMultipleChoiceField):
def label_from_instance(self, obj):
    return f"{obj.name} ({obj.id})"

class EventForm(forms.ModelForm):
venue = VenueChoiceField(
    queryset=Venue.objects.all().order_by('name'), 
    empty_label='장소 선택',
    widget=forms.Select(attrs={
        'class': 'form-select', 'placeholder': '장소 선택'}))
attendees = AttendeeChoiceField(
    queryset=Favorite.objects.all().order_by('-name'), 
    required=False, 
    label =mark_safe('<span style="display: inline-block; font-size: 1rem; margin: 10px; color:red;">참석자</span>'),</pre>
    </article>

    <article>
      <h4 class="doc-subheader"><i class="bi bi-hash"></i>create_event 시 ManyToMany 필드 저장 문제</h4>
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        `form.save(commit=False)`를 사용하면 ManyToMany 필드(attendees)는 자동으로 저장되지 않습니다. 반드시 `form.save_m2m()`을 호출해야 합니다.
      </div>
<pre>
event = form.save(commit=False)
if not request.user.is_superuser:
  event.manager = request.user
event.save()
form.save_m2m()
messages.info(request, "이벤트가 생성되었습니다.")
return redirect('events:events-list')</pre>
    </article>

    <article>
      <h4 class="doc-subheader"><i class="bi bi-hash"></i>event_create에서 venue_id가 있으면 venue 정보를 주입하기</h4>
<pre>
# events views.py
else: # get 
  initial = {}
  if venue_id:
    venue = Venue.objects.get(pk=venue_id)
    initial['venue'] = venue
  if request.user.is_superuser:
    form = EventFormAdmin(initial=initial)
  else:
    form = EventForm(initial=initial)
return render(request, 'events/event_create.html', {'form': form })</pre>
    </article>
  </section>

        <!-- Section 2: Database -->
  <section id="sec-database" class="doc-section">
    <h2 class="doc-header"><i class="bi bi-database me-2"></i>Database 관련 Notes</h2>
    
    <article>
      <h4 class="doc-subheader"><i class="bi bi-hash"></i>DB 테이블 삭제 시 재설정 방법 (Migration Fake)</h4>
      <p>DB 테이블을 강제로 삭제한 경우, 마이그레이션 히스토리와 실제 DB 상태가 일치하지 않아 테이블이 생성되지 않을 수 있습니다. 이때 `--fake` 옵션을 사용합니다.</p>
<pre>
python manage.py migrate asct zero --fake   # asct는 app name
python manage.py migrate asct</pre>
    </article>

    <article>
      <h4 class="doc-subheader"><i class="bi bi-hash"></i>JSON 파일에서 데이터 가져오기</h4>
<pre>
import json
with open('blog/post_data.json', 'r') as f:
posts_json = json.load(f)
for p in posts_json:
post = Post(title=p['title'], content=p['content'], author_id = p['user_id'])
post.save()</pre>
    </article>

    <article>
      <h4 class="doc-subheader"><i class="bi bi-hash"></i>Django Insert 이후 시퀀스 재설정</h4>
      <p>
      PostgreSQL에서 데이터를 INSERT 할 때 id 값을 직접 지정해서 넣으면, 자동 증가(Auto Increment)를 담당하는 시퀀스(Sequence)가 업데이트되지 않아 나중에 중복 키 오류가 발생할 수 있습니다.
      이를 해결하기 위해 시퀀스 값을 현재 테이블의 id 최대값으로 재설정해야 합니다.
      </p>
      
      <h5 class="mt-3 fw-bold text-dark">1. SQL 쿼리로 직접 실행</h5>
<pre>
-- 문법: SELECT setval('테이블명_id_seq', (SELECT MAX(id) FROM 테이블명));
-- 예시: idols 앱의 Idol 모델 테이블이 'idols_idol'인 경우
SELECT setval('idols_idol_id_seq', (SELECT MAX(id) FROM idols_idol));
-- 참고: 테이블 이름과 시퀀스 이름은 실제 DB에 생성된 이름을 확인해야 합니다.</pre>
                
      <h5 class="mt-3 fw-bold text-dark">2. 제공된 fix_seq.py 스크립트 사용 (추천)</h5>
      <p>현재 프로젝트의 `create_data` 폴더에 포함된 스크립트를 사용하면 Django가 자동으로 시퀀스 이름을 찾아 처리합니다.</p>
<pre>
# idols 앱의 시퀀스 재설정
python b:\ASCT_dj_v4\create_data\fix_seq.py idols

# 다른 앱(예: mytodos)의 경우
python b:\ASCT_dj_v4\create_data\fix_seq.py mytodos </pre>
    </article>

    <article>
      <h4 class="doc-subheader"><i class="bi bi-hash"></i>Django DB Backup 및 Restore</h4>
      
      <div class="card mb-3 border-0 bg-light">
        <div class="card-body">
          <h6 class="card-title fw-bold text-primary">dumpdata 명령어 (장고 내장)</h6>
          <p class="card-text small text-muted">장점: DB 종류 무관 / 단점: 대규모 DB 비효율</p>
<pre class="mb-0">
전체 백업: 스페인어, 프랑스어 이상한 문자있으면 애러남
    python manage.py dumpdata > full_backup.json
    python manage.py dumpdata --output full_backup.json
    $env:PYTHONIOENCODING="utf-8"; python manage.py dumpdata --output full_backup_20260117.json
특정 앱만 백업: python manage.py dumpdata 'app_name' > app_data.json
복구 : python manage.py loaddata backup.json</pre>
          </div>
      </div>

      <div class="card mb-3 border-0 bg-light">
        <div class="card-body">
          <h6 class="card-title fw-bold text-primary">django-db-backup 패키지 (자동화)</h6>
<pre class="mb-0">
설치: pip install django-dbbackup 후 settings.py의 INSTALLED_APPS에 추가합니다.
설정: 백업 파일 저장 경로 등을 설정합니다.
백업: python manage.py dbbackup 명령으로 백업 파일을 생성합니다.
복구: python manage.py dbrestore 명령으로 최신 백업 파일에서 복원합니다.
잘안됨(????) </pre>
          </div>
      </div>

      <div class="card border-0 bg-light">
        <div class="card-body">
          <h6 class="card-title fw-bold text-primary">DB별 기본 명령어 사용 (운영 환경)</h6>
          <ul class="small mb-0">
            <li><strong>SQLite:</strong> db.sqlite3 파일 직접 복사</li>
            <li><strong>PostgreSQL/MySQL:</strong> pg_dump, mysqldump 등 전용 도구 사용 (가장 효율적)</li>
          </ul>
        </div>
      </div>
  </article>

  <article>
    <h4 class="doc-subheader"><i class="bi bi-hash"></i>Database idols_idol 내용을 events_favorite에 Insert 하기</h4>
<pre>
-- db에서 직접 수정하기
INSERT INTO events_favorite (name,image, created_at)
SELECT title, image, created_at  -- SQLite의 경우: datetime('now')
FROM idols_idol
WHERE title NOT IN (SELECT name FROM events_favorite);</pre>
  </article>

  <article>
    <h4 class="doc-subheader"><i class="bi bi-hash"></i>PostgreSQL Table의 ID(Primary Key)를 1부터 시작하기</h4>
    <div class="alert alert-danger py-2">
      <i class="bi bi-exclamation-octagon-fill me-2"></i>Foreign Key 참조 무결성이 깨질 수 있으므로 주의하세요.
    </div>
<pre>
-- 1. 기존 테이블과 동일한 구조의 새 테이블 생성 (데이터 제외)
CREATE TABLE blog_post_new (LIKE blog_post INCLUDING ALL);

-- 2. 시퀀스 초기화 (INCLUDING ALL로 시퀀스 설정도 복사되었을 수 있으므로 확실히 하기 위함)
-- new_table의 시퀀스 이름을 확인하여 1로 리셋하거나, 
-- SERIAL 타입이라면 생성 시점에 이미 1부터 시작하도록 되어 있습니다.

-- 3. 데이터 복사 (id 컬럼 제외)
-- id를 제외하고 INSERT 하면 자동으로 1부터 번호가 매겨집니다.
INSERT INTO blog_post_new (title, title_tag, content, date_posted, updated_at, author_id, category_id)
SELECT title, title_tag, content, date_posted, updated_at, author_id, category_id
FROM blog_post
ORDER BY id; -- 기존 id 순서대로 삽입

-- 4. 기존 테이블 삭제 및 새 테이블 이름 변경
DROP TABLE old_table;
ALTER TABLE new_table RENAME TO old_table;

-- 5. 시퀀스 값 동기화 (필요 시)
-- 데이터 삽입 후 시퀀스가 자동으로 증가했는지 확인합니다.
-- 만약 수동으로 id를 넣은 것이 아니라면 setval은 필요 없을 수 있으나, 확인 차원 실행:
SELECT setval(pg_get_serial_sequence('old_table', 'id'), (SELECT MAX(id) FROM old_table));
</pre>
    </article>
</section>

<!-- Section 3: Others -->
<section id="sec-etc" class="doc-section">
    <h2 class="doc-header"><i class="bi bi-gear-wide-connected me-2"></i>기타</h2>
    <article>
        <h4 class="doc-subheader"><i class="bi bi-hash"></i>href를 통해 데이터를 전달할 때 공백 특수문자를 포함</h4>
        <p>전달 값에 필터를(|urlencoder) 사용헤야함</p>
<pre>&lt;a href="&#123;% url 'blog:index' %}?category=&#123;&#123; cat.name|urlencode }}"
    class="text-decoration-none">
&#123;&#123; cat.name }}
&lt;/a></pre>
    </article>
    <article>
        <h4 class="doc-subheader"><i class="bi bi-hash"></i>Gemini 에러 해결</h4>
        <p>2.55.0 버전을 설치하면 에러가 발생하지 않습니다. (최신 버전에서 에러 발생 시)<br>
        VS Code 등의 확장 프로그램 uninstall 항목에서 특정 버전을 선택하여 설치할 수 있습니다.</p>
    </article>

    <article>
        <h4 class="doc-subheader"><i class="bi bi-hash"></i>Form, HTML에서 Required 속성 제거하기</h4>
        <p>HTML5 표준에서 `required` 속성은 값(true/false)과 상관없이 속성이 존재하기만 하면 필수 필드로 인식됩니다.</p>
        <p>따라서 `attrs={'required': 'false'}`로 설정하면 브라우저는 여전히 필수 필드로 인식합니다. <strong>속성 자체를 삭제</strong>해야 빈 값을 허용할 수 있습니다.</p>
    </article>
    <article>
        <h4 class="doc-subheader"><i class="bi bi-hash"></i>views에서 이전 페이지로 이동하기</h4>
        <pre>def store_previous_page(request):
    if request.method == 'GET':
        referer = request.META.get('HTTP_REFERER')
        if referer and request.path not in referer:
            request.session['previous_page'] = referer        </pre>
        <p class="ps-2"><strong>☞ 사용 방법</strong></p>
        <pre>
def favorite_update(request, favorite_id):
    ...
  store_previous_page(request)

  form = FavoriteForm(request.POST or None, request.FILES or None, instance=favorite)
  if form.is_valid():
    form.save()
    # 이전 페이지로 이동을 위한 코드
    return redirect(request.session.pop('previous_page', 'events:favorites-list'))
  return render(request, 'events/favorite_update.html', {'favorite': favorite, 'form': form})</pre>
    </article>
    <article>
        <h4 class="doc-subheader"><i class="bi bi-hash"></i>페이지 정보 전달 및 다시 돌아가기</h4>
        <p class="ps-2">☞ index 페이지에서 이동하는 링크에 <br>
          <code>&#123;% if request.GET.page %}?page=&#123;&#123; request.GET.page }}&#123;% endif %}</code>를 전달하고</p>
        <p class="ps-2">☞ 이동한 페이지에서 list로 다시 이동하는 링크에 <br>
          <code>&#123;% if request.GET.page %}?page=&#123;&#123; request.GET.page }}&#123;% endif %}</code>를 적용한다.</p>
    </article>
</section>

<section id="sec-etc" class="doc-section">
    <h2 class="doc-header"><i class="bi bi-gear-wide-connected me-2"></i>Social Login</h2>
    <article>
        <h4 class="doc-subheader"><i class="bi bi-hash"></i>필요한 설치 패키지</h4>
        <p><strong>☞ pip install</strong></p>
<pre>
✅ django-allauth
✅ requests, oauthlib, cryptography, PyJWT, PyYAML - allauth의 OAuth 필요 패키지
✅ django-debug-toolbar - 설치됨(상관 없음)
✅ reportlab - events 앱의 PDF 생성 기능에 필요한 패키지 설치됨(상관 없음)
✅ psycopg2-binary - PostgreSQL 데이터베이스 연결에 필요한 패키지 설치됨(상관 없음)
✅ requirements.txt - 모든 의존성 정보로 업데이트됨(상관 없음)</pre>
    </article>

    <article>
      <h4 class="doc-subheader"><i class="bi bi-hash"></i>settings.py, urls.py - allauth</h4>
      <p><strong>☞ settings.py</strong></p>
<pre>INSTALLED_APPS = [
    ...
    "allauth",
    "allauth.account",
    "allauth.socialaccount",
    # "allauth.socialaccount.providers.google",
    "allauth.socialaccount.providers.naver",
    "allauth.socialaccount.providers.kakao",
    "allauth.socialaccount.providers.github",
    "allauth.socialaccount.providers.twitter",
    "allauth.socialaccount.providers.facebook",
    "allauth.socialaccount.providers.linkedin_oauth2",
    "allauth.socialaccount.providers.instagram",
]

MIDDLEWARE = [
    ...
    'allauth.account.middleware.AccountMiddleware',
]
AUTHENTICATION_BACKENDS = [
    'django.contrib.auth.backends.ModelBackend',
    'allauth.account.auth_backends.AuthenticationBackend',
]
SITE_ID = 1
# settings.py에서 아래처럼 설정하세요
SOCIALACCOUNT_PROVIDERS = {
    'naver': {
        'SCOPE': ['profile', 'email'],
        'AUTH_PARAMS': {},
    }
}</pre>
<p><strong>☞ urls.py</strong></p>
  <pre>urlpatterns = [
    path('admin/', admin.site.urls),
    path('accounts/', include('allauth.urls')),
    ...
]
</pre>
    </article>

</section>
</div>
{% endblock %}